## **Cách thức hoạt động của GraphQL**

- 3 hoạt động chính GraphQL:
    - query tìm nạp dữ liệu
    - Thêm, xóa, thay đổi dữ liệu
    - Đăng ký (tương tự như query nhưng thiết lập kết nối vĩnh viễn để máy chủ có thể chủ động đẩy dữ liệu đến máy khách theo định dạng đã chỉ định).

- GraphQL thường được gửi bằng request POST, và các phản hồi của GraphQL dưới dang JSON.

## **GraphQL schema là gì?**

- GraphQL schema: định nghĩa dữ liệu có sẵn dưới dạng một loạt các loại, sử dụng ngôn ngữ định nghĩa lược đồ mà con người có thể đọc được.

```
# Example schema definition
type Product {
    id: ID!
    name: String!
    description: String!
    price: Int
}
```

- Các toán tử "!" chỉ ra rằng trường này không thể rỗng khi được gọi (nghĩa là bắt buộc).

## **Query GraphQL schema**

- Ví dụ bên dưới hiển thị query có tên `myGetProductQuery` yêu cầu `name` và `description` của sản phẩm có id là 123.

```
#Example query
query myGetProductQuery {
    getProduct(id: 123) {
        name
        description
    }
}
```

- Ví dụ thêm một đối tượng GraphQL

```
#Example mutation request
mutation {
    createProduct(name: "Flamin' Cocktail Glasses", listed: "yes") {
        id
        name
        listed
    }
}
#Example mutation response
{
    "data": {
        "createProduct": {
        "id": 123,
        "name": "Flamin' Cocktail Glasses",
        "listed": "yes"
        }
    }
}
```

## **Các thành phần của GraphQL**

> `Field`

```
#Request
query myGetEmployeeQuery {
    getEmployees {
        id
        name {
            firstname
            lastname
        }
    }
}
------------------------------------------------------------------------------------------------------------------------
#Response
{
    "data": {
        "getEmployees": [
            {
                "id": 1,
                "name" {
                    "firstname": "Carlos",
                    "lastname": "Montoya"
                    }
            },
            {
                "id": 2,
                "name" {
                    "firstname": "Peter",
                    "lastname": "Wiener"
                 }
            }
        ]
    }
}
```

> `Arguments`

```
#Example query with arguments
query myGetEmployeeQuery {
    getEmployees(id:1) {
        name {
            firstname
            lastname
        }
    }
}
------------------------------------------------------------------------------------------------------------------------
#Response to query
{
    "data": {
        "getEmployees": [
            {
                "name" {
                    "firstname": Carlos,
                    "lastname": Montoya
                }
            }
        ]
    }
}
```

> `Variables`

- Các biến cho phép bạn truyền các đối số động thay vì có các đối số trực tiếp trong chính query đó.

- query dựa trên biến sử dụng cấu trúc giống như query sử dụng đối số nội tuyến, nhưng một số khía cạnh nhất định của query được lấy từ từ điển biến dựa trên JSON riêng biệt. Chúng cho phép bạn sử dụng lại cấu trúc chung giữa nhiều query, chỉ có giá trị của biến đó thay đổi.

```
#Example query with variable
query getEmployeeWithVariable($id: ID!) {
    getEmployees(id:$id) {
        name {
            firstname
            lastname
        }
    }
}
Variables:
{
    "id": 1
}
```

> `Aliases`

- Đối tượng GraphQL không thể chứa nhiều thuộc tính có cùng tên. Ví dụ: query sau không hợp lệ vì nó cố gắng trả về loại sản phẩm hai lần.

```
#Invalid query
query getProductDetails {
    getProduct(id: 1) {
        id
        name
    }
    getProduct(id: 2) {
        id
        name
    }
}
```

- Query hợp lệ sử dụng alias

```
#Valid query using aliases
query getProductDetails {
    product1: getProduct(id: "1") {
        id
        name
    }
    product2: getProduct(id: "2") {
        id
        name
    }
}
```

> `Fragments`

- Fragments là các phần có thể tái sử dụng của query hoặc xóa thêm dữ liệu. Chúng chứa một tập hợp con các trường thuộc loại liên quan.

- Sau khi được xác định, chúng có thể được đưa vào các query hoặc xóa thêm dữ liệu. Nếu sau đó chúng được thay đổi thì thay đổi đó sẽ được bao gồm trong mọi query hoặc xóa thêm dữ liệu gọi phân đoạn.

```
#Example fragment
fragment productInfo on Product {
    id
    name
    listed
}

#Query calling the fragment
query {
    getProduct(id: 1) {
        ...productInfo
        stock
    }
}

#Response including fragment fields
{
    "data": {
        "getProduct": {
            "id": 1,
            "name": "Juice Extractor",
            "listed": "no",
            "stock": 5
        }
    }
}
```

## **Tìm kiếm các GraphQL endpoints**

- Trước khi có thể kiểm tra API GraphQL, trước tiên bạn cần tìm điểm cuối của nó. Vì API GraphQL sử dụng cùng một điểm cuối cho tất cả các yêu cầu nên đây là một thông tin có giá trị.

> **`Universal queries (query chung)`**

- Nếu bạn gửi `query{__typename}` đến bất kỳ điểm cuối GraphQL nào, nó sẽ bao gồm chuỗi `{"data": {"__typename": "query"}}` ở đâu đó trong phản hồi của nó. Đây được gọi là query chung và là công cụ hữu ích trong việc kiểm tra xem URL có tương ứng với dịch vụ GraphQL hay không.

> **`Các endpoint names phổ biến`**

- /graphql
- /api
- /api/graphql
- /graphql/api
- /graphql/graphql

> **`Request methods`**

- Có request Post dữ liệu gửi đi dưới dạng JSON

## **Khám phá thông tin schema**

- Bước tiếp theo trong việc kiểm tra API là ghép các thông tin về lược đồ cơ bản lại với nhau.

- Cách tốt nhất để làm điều này là sử dụng các truy vấn introspection. Introspection là một hàm GraphQL tích hợp cho phép bạn truy vấn máy chủ để biết thông tin về lược đồ.

- Việc xem xét introspection giúp bạn hiểu cách bạn có thể tương tác với API GraphQL. Nó cũng có thể tiết lộ dữ liệu có khả năng nhạy cảm, chẳng hạn như trường mô tả.

### **Sử dụng introspection**

> `Probing for introspection`

- Bạn có thể thăm dò sự xem xét introspection bằng cách sử dụng truy vấn đơn giản sau đây. Nếu tính năng xem xét introspection được bật, phản hồi sẽ trả về tên của tất cả các truy vấn có sẵn.


```
#Introspection probe request

    {
        "query": "{__schema{queryType{name}}}"
    }
```

> `Running a full introspection query`

```
#Full introspection query

    query IntrospectionQuery {
        __schema {
            queryType {
                name
            }
            mutationType {
                name
            }
            subscriptionType {
                name
            }
            types {
             ...FullType
            }
            directives {
                name
                description
                args {
                    ...InputValue
            }
            onOperation  #Often needs to be deleted to run query
            onFragment   #Often needs to be deleted to run query
            onField      #Often needs to be deleted to run query
            }
        }
    }

    fragment FullType on __Type {
        kind
        name
        description
        fields(includeDeprecated: true) {
            name
            description
            args {
                ...InputValue
            }
            type {
                ...TypeRef
            }
            isDeprecated
            deprecationReason
        }
        inputFields {
            ...InputValue
        }
        interfaces {
            ...TypeRef
        }
        enumValues(includeDeprecated: true) {
            name
            description
            isDeprecated
            deprecationReason
        }
        possibleTypes {
            ...TypeRef
        }
    }

    fragment InputValue on __InputValue {
        name
        description
        type {
            ...TypeRef
        }
        defaultValue
    }

    fragment TypeRef on __Type {
        kind
        name
        ofType {
            kind
            name
            ofType {
                kind
                name
                ofType {
                    kind
                    name
                }
            }
        }
    }

```

- Sau khi nhận được kết quả sử dụng công cụ sau đây để nhìn một cách trực quan: [**GraphQL visualizer**](http://nathanrandal.com/graphql-visualizer/)
